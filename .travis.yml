language: go

go:
  - "1.11.x"

install:
  - go get -u github.com/golang/dep/...
  - dep ensure

branches:
  only:
    - master

before_script:
  - echo $TRAVIS
  - echo $TRAVIS_PULL_REQUEST
  - echo $TRAVIS_PULL_REQUEST_BRANCH
  - echo $TRAVIS_COMMIT
  - echo $TRAVIS_PULL_REQUEST_SHA
  - echo $TRAVIS_REPO_SLUG
  - echo $TRAVIS_SECURE_ENV_VARS
  - LAST_BUILD=`cat version.txt`
  - TRAVIS_TAG=`ci/scripts/rc_bump.sh $LAST_BUILD`


script:
  - go test -v -race $(go list ./... | grep -v "/vendor/")
  - go get github.com/haya14busa/goverage
  - goverage -coverprofile=coverage.txt ./...

after_success:
  -  bash <(curl -s https://codecov.io/bash)

before_deploy:
  - go get github.com/mitchellh/gox
  - gox -osarch "linux/amd64" -output "dist/{{.Dir}}_{{.OS}}_{{.Arch}}" github.com/kcajmagic/testing
  - echo $TRAVIS_TAG
  - git checkout master
  - echo $TRAVIS_TAG > version.txt
  - git config --global user.email "travis@travis-ci.org"
  - git config --global user.name "Travis CI"
  - git remote add origin-version https://${GH_TOKEN}@github.com/kcajmagic/testing.git > /dev/null 2>&1
  - git commit -am "[skip travis] Travis build $TRAVIS_BUILD_NUMBER update version to $TRAVIS_TAG"
  - git push origin-version master

deploy:
  provider: releases
  prerelease: true
  overwrite: true
  api_key: "$AUTH_TOKEN_BUILD"
  file:
    - dist/testing_linux_amd64
  name: CI Build
  body: "Build $TRAVIS_TAG

  $TRAVIS_COMMIT_MESSAGE"
  skip_cleanup: true
  on:
    condition: "$TRAVIS_PULL_REQUEST = false"